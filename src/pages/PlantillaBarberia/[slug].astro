---
export const prerender = false;

import BarberiaLayout from "../../layouts/BarberiaLayout.astro";
import NavbarBarberia from "../../components/PlantillaBarberia/NavbarBarberia";
import HeroBarberia from "../../components/PlantillaBarberia/HeroBarberia";
import ServiciosBarberia from "../../components/PlantillaBarberia/ServiciosBarberia";
import SobreNosotros from "../../components/PlantillaBarberia/SobreNosotros";
import Resenas from "../../components/PlantillaBarberia/Resenas";
import FooterBarberia from "../../components/PlantillaBarberia/FooterBarberia";
import AgendarTurno from "../../components/PlantillaBarberia/AgendarTurno";
import UbicacionBarberia from "../../components/PlantillaBarberia/UbicacionBarberia";

import { db } from "../../lib/firebase";
import { collection, query, where, getDocs } from "firebase/firestore";
import { fuentesStyle } from "../../lib/fonts";

// üìå Definimos el tipo de negocio (campos que puede traer de Firestore)
type Negocio = {
  id: string;
  nombre: string;
  hoverColor?: string;
  fuenteLogo?: string;
  fuenteBotones?: string;
  fuenteTexto?: string;
  modoImagenes?: string;
  bannerImages?: { url: string }[];
  empleadosData?: any[];
  eslogan?: string;
  usarLogo?: boolean;
  logoUrl?: string;
  ubicacion?: {
    lat: number;
    lng: number;
    direccion?: string;
  };
  telefono?: string;
  emailContacto?: string;
  sobreNosotrosImages?: { url: string; deleteUrl?: string }[];
  modoSobreNosotros?: "defecto" | "personalizado";
};


const { slug } = Astro.params;

let negocio: Negocio | null = null;
const q = query(collection(db, "Negocios"), where("slug", "==", slug));
const snap = await getDocs(q);

if (!snap.empty) {
  const docSnap = snap.docs[0];
  negocio = { id: docSnap.id, ...docSnap.data() } as Negocio; // üëà hacemos el cast
}

const hoverColor = negocio?.hoverColor || "#3b82f6";
const fuenteLogo = negocio?.fuenteLogo || "montserrat";
const fuenteBotones = negocio?.fuenteBotones || "poppins";
const fuenteTexto = negocio?.fuenteTexto || "raleway";
const modoImagenes = (negocio?.modoImagenes as "defecto" | "personalizado") || "defecto";


const heroImages =
  modoImagenes === "personalizado" && negocio?.bannerImages?.length
    ? negocio.bannerImages
    : ["/img/1.jpeg", "/img/2.jpg", "/img/3.jpg"];

const css = `
  :root {
    --hoverColor: ${hoverColor};
    --logoFont: ${fuentesStyle[fuenteLogo] || "sans-serif"};
  }

  .negocio a,
  .negocio button {
    transition: background-color 0.3s ease, color 0.3s ease;
  }

  .negocio a:hover,
  .negocio button:hover {
    background-color: var(--hoverColor);
    color: white;
    border-color: var(--hoverColor);
  }
`;
---

{!negocio ? (
  <h1 class="text-center text-2xl mt-10">‚ùå Este negocio no existe.</h1>
) : (
  <BarberiaLayout title={negocio.nombre}>
    <!-- üé® Inyectar estilos din√°micos -->
    <style is:global>{css}</style>

    <!-- ‚úÖ Navbar -->
    <NavbarBarberia
      title={negocio.nombre}
      hoverColor={hoverColor}
      logoUrl={negocio.usarLogo ? negocio.logoUrl : null}
      fuenteLogo={fuenteLogo}
      fuenteTexto={fuenteTexto}
      fuenteBotones={fuenteBotones}
      client:load
    />

    <!-- ‚úÖ Hero -->
    <HeroBarberia
      client:load
      images={heroImages}
      modoImagenes={modoImagenes}
      nombre={negocio.nombre}
      eslogan={negocio.eslogan}
      fuenteLogo={fuenteLogo}
      fuenteTexto={fuenteTexto}
      fuenteBotones={fuenteBotones}
    />

    <!-- üöÄ Nueva secci√≥n Servicios -->
    <div id="servicios">
      <ServiciosBarberia 
        fuenteTexto={fuenteTexto} 
        fuenteBotones={fuenteBotones} 
        client:load 
      />
    </div>

 <!-- üöÄ Nueva secci√≥n Sobre Nosotros -->
<div id="sobre-nosotros" class="mt-10">
  <SobreNosotros 
    fuenteTexto={fuenteTexto} 
    fuenteBotones={fuenteBotones}
    sobreNosotrosImages={negocio?.sobreNosotrosImages || []}
    modoSobreNosotros={negocio?.modoSobreNosotros || "defecto"}
    client:load 
  />
</div>



    <!-- üöÄ Nueva secci√≥n Agendar Turno -->
    <div id="agendar-turno" class="mt-10">
      <AgendarTurno 
        empleados={negocio.empleadosData || []}
        fuenteTexto={fuenteTexto} 
        fuenteBotones={fuenteBotones}
        negocioId={negocio.id}
        client:load 
      />
    </div>

    <!-- ‚úÖ Secci√≥n Ubicaci√≥n -->
<div id="ubicacion" class="mt-10">
  <UbicacionBarberia 
    nombre={negocio.nombre}
    ubicacion={negocio.ubicacion}
    client:load
  />
</div>

    <!-- ‚úÖ Secci√≥n Rese√±as -->
    <div id="rese√±as" class="mt-10">
      <Resenas 
        fuenteTexto={fuenteTexto} 
        fuenteBotones={fuenteBotones}
        client:load 
      />
    </div>

    <!-- ‚úÖ Footer -->
<FooterBarberia 
  nombre={negocio.nombre}
  eslogan={negocio.eslogan}
  fuenteTexto={fuenteTexto}
  fuenteBotones={fuenteBotones}
  telefono={negocio?.telefono}
  emailContacto={negocio?.emailContacto}
  lat={negocio?.ubicacion?.lat}
  lng={negocio?.ubicacion?.lng}
  client:load
/>

  </BarberiaLayout>
)}
