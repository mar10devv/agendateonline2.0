---
export const prerender = false;

import BarberiaLayout from "../../layouts/BarberiaLayout.astro";
import NavbarBarberia from "../../components/barberia/NavbarBarberia";
import { db } from "../../lib/firebase";
import { collection, query, where, getDocs } from "firebase/firestore";
import { fuentesMap, fuentesStyle } from "../../lib/fonts";

// ğŸ“Œ Obtenemos el slug desde la URL
const { slug } = Astro.params;

// ğŸ“Œ Buscamos el negocio en Firestore (colecciÃ³n Negocios)
let negocio = null;
const q = query(collection(db, "Negocios"), where("slug", "==", slug));
const snap = await getDocs(q);

if (!snap.empty) {
  negocio = snap.docs[0].data();
}

// ğŸ“Œ Variables dinÃ¡micas
const hoverColor = negocio?.hoverColor || "#3b82f6";
const fuenteLogo = negocio?.fuenteLogo || "montserrat";
const fuenteBotones = negocio?.fuenteBotones || "poppins";
const fuenteTexto = negocio?.fuenteTexto || "raleway";

// ğŸ“Œ Modo imÃ¡genes desde Firestore
const modoImagenes = negocio?.modoImagenes || "defecto";

// âœ… Usar imÃ¡genes segÃºn el modo
const heroImages =
  modoImagenes === "personalizado" && negocio?.bannerImages?.length
    ? negocio.bannerImages
    : ["/img/1.jpeg", "/img/2.jpg", "/img/3.jpg"];

// ğŸ¨ Estilos dinÃ¡micos
const css = `
  :root {
    --hoverColor: ${hoverColor};
    --logoFont: ${fuentesStyle[fuenteLogo] || "sans-serif"};
  }

  .negocio a,
  .negocio button {
    transition: background-color 0.3s ease, color 0.3s ease;
  }

  .negocio a:hover,
  .negocio button:hover {
    background-color: var(--hoverColor);
    color: white;
    border-color: var(--hoverColor);
  }
`;
---

{!negocio ? (
  <h1 class="text-center text-2xl mt-10">âŒ Este negocio no existe.</h1>
) : (
  <BarberiaLayout
    title={negocio.nombre}
    hoverColor={hoverColor}
    logoUrl={negocio.usarLogo ? negocio.logoUrl : null}
    heroImages={heroImages}
    modoImagenes={modoImagenes}
    nombre={negocio.nombre}
    eslogan={negocio.eslogan}
    fuenteLogo={fuenteLogo}
    fuenteTexto={fuenteTexto}
    fuenteBotones={fuenteBotones}
  >
    <!-- ğŸ¨ Inyectar estilos dinÃ¡micos -->
    <style is:global>{css}</style>

    <!-- âœ… Navbar -->
    <NavbarBarberia
      title={negocio.nombre}
      hoverColor={hoverColor}
      logoUrl={negocio.usarLogo ? negocio.logoUrl : null}
      fuenteLogo={fuenteLogo}
      fuenteTexto={fuenteTexto}
      fuenteBotones={fuenteBotones}
      client:load
    />

    <!-- âœ… Ejemplo de secciones -->
    <section class="negocio space-y-6 mt-6 p-6 border rounded bg-white shadow-sm">
      <a
        href="#servicios"
        class={`inline-block px-4 py-2 border rounded font-medium ${fuentesMap[fuenteBotones]}`}
      >
        Ver servicios
      </a>
      <button
        class={`px-4 py-2 border rounded font-medium ${fuentesMap[fuenteBotones]}`}
      >
        Reservar turno
      </button>
    </section>

    <section class="negocio mt-8 grid md:grid-cols-2 gap-4">
      <div class="border p-4 rounded shadow-sm hover:shadow-md">
        <h3 class={`font-bold mb-2 ${fuentesMap[fuenteTexto]}`}>ğŸ”¥ Promo destacada</h3>
        <p class={`${fuentesMap[fuenteTexto]}`}>
          {negocio.promo || "Primera visita con 20% de descuento"}
        </p>
      </div>
      <div class="border p-4 rounded shadow-sm hover:shadow-md">
        <h3 class={`font-bold mb-2 ${fuentesMap[fuenteTexto]}`}>â­ Servicios mÃ¡s populares</h3>
        <p class={`${fuentesMap[fuenteTexto]}`}>
          Corte + barba, Tinte, Peinados
        </p>
      </div>
    </section>
  </BarberiaLayout>
)}
